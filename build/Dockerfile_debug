FROM devtools/go-toolset-rhel7:1.11.13-10 AS build-env

USER root

ENV OPERATOR=/activemq-artemis-operator/activemq-artemis-operator \
    CGO_ENABLED=0 \
    GOPATH=/go

RUN mkdir -p ${GOPATH}/src/github.com/rh-messaging/activemq-artemis-operator/bin
RUN mkdir -p /activemq-artemis-operator
ADD . ${GOPATH}/src/github.com/rh-messaging/activemq-artemis-operator
WORKDIR ${GOPATH}/src/github.com/rh-messaging/activemq-artemis-operator
RUN scl enable go-toolset-1.11 "go build -gcflags \"all=-N -l\" -v -o ${OPERATOR} ${GOPATH}/src/github.com/rh-messaging/activemq-artemis-operator/cmd/manager"

# Get Delve from a GOPATH not from a Go Modules project
# as we aren't using Go Modules yet
RUN scl enable go-toolset-1.11 "go get github.com/go-delve/delve/cmd/dlv"

FROM devtools/go-toolset-rhel7:1.11.13-10

USER root

ENV OPERATOR=/activemq-artemis-operator/activemq-artemis-operator \
    USER_UID=1001 \
    USER_NAME=activemq-artemis-operator \
    CGO_ENABLED=0 \
    GOPATH=/go
ENV HOME=/home/${USER_NAME}

COPY --from=build-env ${OPERATOR} /activemq-artemis-operator/
COPY --from=build-env ${GOPATH}/src/github.com/rh-messaging/activemq-artemis-operator/build/bin /home/activemq-artemis-operator/bin

RUN mkdir -p ${HOME}
COPY --from=build-env ${GOPATH}/bin/dlv ${HOME}/
RUN chown -R ${USER_UID}:0 ${HOME} && \
    chmod -R g=u ${HOME} /etc/passwd
USER ${USER_UID}
WORKDIR ${HOME}

ENTRYPOINT ["/home/activemq-artemis-operator/bin/entrypoint_debug"]

